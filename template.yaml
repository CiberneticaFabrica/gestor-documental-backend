AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >
  document-manager-user-management
 
  Sample SAM Template for document-manager-user-management
 
# More info about Globals: https://github.com/awslabs/serverless-application-model/blob/master/docs/globals.rst
Globals:
  Function:
    Timeout: 60
    MemorySize: 128
    Tracing: Active
    Runtime: python3.9
    Environment:
      Variables:
        DB_HOST: !Ref DBHost
        DB_USER: !Ref DBUser
        DB_PASSWORD: !Ref DBPassword
        DB_NAME: !Ref DBName
        SESSION_EXPIRY_MINUTES: 1440
  Api:
    TracingEnabled: true
    # Configuración global de CORS para todas las APIs
    Cors:
      AllowMethods: "'GET, POST, PUT, DELETE, OPTIONS'"
      AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
      AllowOrigin: "'*'"  # En producción, específica tus dominios en lugar de *
      MaxAge: "'600'"
 
Parameters:
  DBHost:
    Type: String
    Default: fabrica-gestor-documental.c642nkfthejp.us-east-1.rds.amazonaws.com
    Description: RDS Host Address
  DBName:
    Type: String
    Default: fabrica-gestor-documental
    Description: Database Name
  DBUser:
    Type: String
    Default: admin
    Description: Database Username
  DBPassword:
    Type: String
    NoEcho: true
    Description: Database Password
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC where the Lambda functions will run
  PrivateSubnet1:
    Type: AWS::EC2::Subnet::Id
    Description: First private subnet for Lambda functions
  PrivateSubnet2:
    Type: AWS::EC2::Subnet::Id
    Description: Second private subnet for Lambda functions
 
Resources:
  # Definición del API Gateway con CORS habilitado
  ApiGateway:
    Type: AWS::Serverless::Api
    Properties:
      StageName: Prod
      Cors:
        AllowMethods: "'GET, POST, PUT, DELETE, OPTIONS'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowOrigin: "'*'"  # En producción, específica tus dominios en lugar de *
        MaxAge: "'600'"

  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: auth.authentication.app.lambda_handler
      Runtime: python3.9
      Architectures:
        - x86_64
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Events:
        # Manejamos OPTIONS para cada ruta para CORS preflight
        LoginOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/login
            Method: OPTIONS
        Login:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/login
            Method: POST
        LogoutOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/logout
            Method: OPTIONS
        Logout:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/logout
            Method: POST
        RegisterOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/register
            Method: OPTIONS
        Register:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/register
            Method: POST
        ValidateOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/validate
            Method: OPTIONS
        Validate:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/validate
            Method: POST
        RefreshOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/refresh
            Method: OPTIONS
        Refresh:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/refresh
            Method: POST
        PasswordChangeOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/password/change
            Method: OPTIONS
        PasswordChange:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/password/change
            Method: POST
        RequestPasswordResetOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/password/reset/request
            Method: OPTIONS
        RequestPasswordReset:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/password/reset/request
            Method: POST
        PasswordResetOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/password/reset/confirm
            Method: OPTIONS
        PasswordReset:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/password/reset/confirm
            Method: POST
        2faSetupOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/2fa/setup
            Method: OPTIONS
        2faSetup:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/2fa/setup
            Method: POST
        2faVerifyOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/2fa/verify
            Method: OPTIONS
        2faVerify:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/2fa/verify
            Method: POST
        2faLoginOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/2fa/login
            Method: OPTIONS
        2faLogin:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /auth/2fa/login
            Method: POST
  UserFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: users.app.lambda_handler
      Runtime: python3.9
      Architectures:
        - x86_64
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Events:    
          GetUsersOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users
              Method: OPTIONS
          GetUsers:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users
              Method: GET
          GetUserOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}
              Method: OPTIONS
          GetUser:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}
              Method: GET
          CreateUserOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users
              Method: OPTIONS
          CreateUser:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users
              Method: POST
          UpdateUserOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}
              Method: OPTIONS
          UpdateUser:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}
              Method: PUT
          DeleteUserOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}
              Method: OPTIONS
          DeleteUser:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}
              Method: DELETE
          GetUserActivityOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/activity
              Method: OPTIONS
          GetUserActivity:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/activity
              Method: GET
          GetActiveSessionsOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/sessions
              Method: OPTIONS
          GetActiveSessions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/sessions
              Method: GET
          DisableUserOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/disable
              Method: OPTIONS
          DisableUser:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/disable
              Method: PUT
          ForcePasswordChangeOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/force-password-change
              Method: OPTIONS
          ForcePasswordChange:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/force-password-change
              Method: PUT
          GetUserRolesOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/roles
              Method: OPTIONS  
          GetUserRoles:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/roles
              Method: GET  
          AssignUserRolesOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/roles/assign
              Method: OPTIONS
          AssignUserRoles:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/roles/assign
              Method: POST
          UpdateUserRolesOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/roles
              Method: OPTIONS
          UpdateUserRoles:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/roles
              Method: PUT
          RemoveUserRolesOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/roles/remove
              Method: OPTIONS
          RemoveUserRoles:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/roles/remove
              Method: DELETE
          GetUserGroupsOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/groups
              Method: OPTIONS
          GetUserGroups:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/groups
              Method: GET
          AssignUserGroupsOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/groups/assign
              Method: OPTIONS
          AssignUserGroups:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/groups/assign
              Method: POST
          UpdateUserGroupsOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/groups
              Method: OPTIONS
          UpdateUserGroups:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/groups
              Method: PUT 
          RemoveUserGroupsOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/groups/remove
              Method: OPTIONS
          RemoveUserGroups:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/groups/remove
              Method: POST
          GetUserPermissionsOptions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/permissions
              Method: OPTIONS
          GetUserPermissions:
            Type: Api
            Properties:
              RestApiId: !Ref ApiGateway
              Path: /users/{id}/permissions
              Method: GET
  PermissionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: permissions.app.lambda_handler
      Runtime: python3.9
      Architectures:
        - x86_64
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Events:
        # Rutas de gestión de roles
        ListRolesOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles
            Method: OPTIONS
        ListRoles:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles
            Method: GET
        GetRoleOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}
            Method: OPTIONS
        GetRole:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}
            Method: GET
        CreateRoleOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles
            Method: OPTIONS
        CreateRole:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles
            Method: POST
        UpdateRoleOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}
            Method: OPTIONS
        UpdateRole:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}
            Method: PUT
        DeleteRoleOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}
            Method: OPTIONS
        DeleteRole:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}
            Method: DELETE 
        # Rutas de gestión de permisos
        ListPermissionsOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions
            Method: OPTIONS
        ListPermissions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions
            Method: GET
        GetPermissionOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions/{id}
            Method: OPTIONS
        GetPermission:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions/{id}
            Method: GET
        CreatePermissionOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions
            Method: OPTIONS
        CreatePermission:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions
            Method: POST
        UpdatePermissionOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions/{id}
            Method: OPTIONS
        UpdatePermission:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions/{id}
            Method: PUT
        DeletePermissionOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions/{id}
            Method: OPTIONS
        DeletePermission:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /permissions/{id}
            Method: DELETE
        # Rutas de gestión de roles-permisos
        GetRolePermissionsOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}/permissions
            Method: OPTIONS
        GetRolePermissions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}/permissions
            Method: GET
        AssignPermissionsToRoleOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}/permissions
            Method: OPTIONS
        AssignPermissionsToRole:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}/permissions
            Method: POST
        RemovePermissionsFromRoleOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}/permissions
            Method: OPTIONS
        RemovePermissionsFromRole:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}/permissions
            Method: DELETE
        CheckRolePermissionOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}/permissions/{permission_id}
            Method: OPTIONS
        CheckRolePermission:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /roles/{id}/permissions/{permission_id}
            Method: GET     
        # Rutas de gestión de permisos de usuario
        GetUserPermissionsOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /users/{id}/permission
            Method: OPTIONS
        GetUserPermissions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /users/{id}/permission
            Method: GET
        CheckPermissionOptions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /users/{id}/permissions/{permission_code}
            Method: OPTIONS
        CheckPermission:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /users/{id}/permissions/{permission_code}
            Method: GET
  DocumentFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: documents.app.lambda_handler
      Runtime: python3.9
      Architectures:
        - x86_64
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Events:
        # Document management routes con OPTIONS para CORS
        ListDocuments:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /documents
            Method: GET
        GetDocument:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /documents/{id}
            Method: GET
        CreateDocument:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /documents
            Method: POST
        UpdateDocument:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /documents/{id}
            Method: PUT
        DeleteDocument:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /documents/{id}
            Method: DELETE
        # Document versions routes con OPTIONS para CORS
        ListDocumentVersions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /documents/{id}/versions
            Method: GET
        GetDocumentVersion:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /documents/{id}/versions/{version_id}
            Method: GET
        CreateDocumentVersion:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /documents/{id}/versions
            Method: POST
        # Document history route con OPTIONS para CORS
        GetDocumentHistory:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /documents/{id}/history
            Method: GET
  FolderFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: folders.app.lambda_handler
      Runtime: python3.9
      Architectures:
        - x86_64
      Policies:
        - VPCAccessPolicy: {}
      VpcConfig:
        SecurityGroupIds:
          - !Ref LambdaSecurityGroup
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2
      Events:
        # Rutas de gestión de carpetas
        ListFolders:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /folders
            Method: GET
        GetFolder:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /folders/{id}
            Method: GET
        CreateFolder:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /folders
            Method: POST
        UpdateFolder:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /folders/{id}
            Method: PUT
        DeleteFolder:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /folders/{id}
            Method: DELETE
        # Rutas de gestión de documentos en carpetas
        ListFolderDocuments:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /folders/{id}/documents
            Method: GET
        # Rutas de gestión de permisos de carpetas
        GetFolderPermissions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /folders/{id}/permissions
            Method: GET
        SetFolderPermissions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /folders/{id}/permissions
            Method: POST
        RemoveFolderPermissions:
          Type: Api
          Properties:
            RestApiId: !Ref ApiGateway
            Path: /folders/{id}/permissions
            Method: DELETE
  ApplicationResourceGroup:
    Type: AWS::ResourceGroups::Group
    Properties:
      Name:
        Fn::Sub: ApplicationInsights-SAM-${AWS::StackName}
      ResourceQuery:
        Type: CLOUDFORMATION_STACK_1_0
  ApplicationInsightsMonitoring:
    Type: AWS::ApplicationInsights::Application
    Properties:
      ResourceGroupName:
        Ref: ApplicationResourceGroup
      AutoConfigurationEnabled: 'true'
  LambdaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Lambda functions to access RDS
      VpcId: !Ref VpcId
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 3306
          ToPort: 3306
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

Outputs:
  ApiGatewayUrl:
    Description: URL of the API Gateway
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/Prod/"
  AuthApi:
    Description: API Gateway endpoint URL for Prod stage for Auth function
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/Prod/auth/"
  AuthFunctionArn:
    Description: Auth Lambda Function ARN
    Value: !GetAtt AuthFunction.Arn
  AuthFunctionIamRole:
    Description: Implicit IAM Role created for Auth function
    Value: !GetAtt AuthFunctionRole.Arn
  # Add to existing Outputs section
  PermissionsApi:
    Description: API Gateway endpoint URL for Prod stage for Permissions function
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/Prod/roles/"
  PermissionsFunctionArn:
    Description: Permissions Lambda Function ARN
    Value: !GetAtt PermissionsFunction.Arn
  PermissionsFunctionIamRole:
    Description: Implicit IAM Role created for Permissions function
    Value: !GetAtt PermissionsFunctionRole.Arn
  # Add new outputs for DocumentFunction
  DocumentsApi:
    Description: API Gateway endpoint URL for Prod stage for Document function
    Value: !Sub "https://${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com/Prod/documents/"
  DocumentFunctionArn:
    Description: Document Lambda Function ARN
    Value: !GetAtt DocumentFunction.Arn
  DocumentFunctionIamRole:
    Description: Implicit IAM Role created for Document function
    Value: !GetAtt DocumentFunctionRole.Arn